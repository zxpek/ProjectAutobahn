---
title: "Student Scores"
author: "Group 4"
date: "9 October 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load data and libraries
```{r}
library(ggplot2)
library(reshape)
library(plyr)
mat_ds <- read.csv("data/student-mat.csv", header=TRUE)
por_ds <- read.table("data/student-por.csv", sep=";", header=TRUE)


```

## Initial look at the dataset
```{r}
head(mat_ds, n = 10)
head(por_ds, n = 10)
```

## Overarching Question
What demographic, social, and school related variables affect test scores in a high school environment? Do these factors differ in a math versus as language class?

# Dataset Description
Source: Paulo Cortez, University of Minho, GuimarÃ£es, Portugal, http://www3.dsi.uminho.pt/pcortez
This data samples student achievement in secondary education of two Portuguese schools. 
The data was collected by using school reports and questionnaires. 
Two datasets are included regarding the performance in two distinct subjects: Mathematics (mat) and Portuguese language (por). 
The dataset contains 32 Variables. Most variables are categorical across a number of factors that attempt to predict end of the semester scores.

Variable  | Description | Type | Contents 
--------------|--------------|---------
School      | Student's school | Binary: "GP" - Gabriel Pereira or "MS" - Mousinho da Silveira  
Sex         | Student's sex | Binary: "F" - female or "M" - male  
Age         | Student's age | Numeric: from 15 to 22  
Address     | Student's home address type | Binary: "U" - urban or "R" - rural  
Famsize     | Family size | Binary: "LE3" - less or equal to 3 or "GT3" - greater than 3  
Pstatus     | Parent's cohabitation status | Binary: "T" - living together or "A" - apart  
Medu        | Mother's education | Categorical: 0 - none,  1 - primary education, 2 – 5th to 9th grade, 3 – secondary education or 4 – higher education  
Fedu        | Father's education | Categorical: 0 - none,  1 - primary education, 2 – 5th to 9th grade, 3 – secondary education or 4 – higher education)  
Mjob        | Mother's job | Nominal: "teacher", "health" care related, civil "services" (e.g. administrative or police), "at_home" or "other"  
Fjob        | Father's job | Nominal: "teacher", "health" care related, civil "services" (e.g. administrative or police), "at_home" or "other"  
Reason      | Reason to choose this school | Categorical: close to "home", school "reputation", "course" preference or "other")  
Guardian    | Student's guardian | Categorical: "mother", "father" or "other"  
Traveltime  | Home to school travel time | Categorical: 1 - <15 min., 2 - 15 to 30 min., 3 - 30 min. to 1 hour, or 4 - >1 hour  
Studytime   | Weekly study time | Categorical: 1 - <2 hours, 2 - 2 to 5 hours, 3 - 5 to 10 hours, or 4 - >10 hours  
Failures    | Number of past class failures | Categorical: n if 1<=n<3, else 4  
Schoolsup   | Extra educational support provided by school| Binary: yes or no  
Famsup      | Family educational support | Binary: yes or no  
Paid        | Extra paid classes within the course subject (Math or Portuguese) | Binary: yes or no  
Activities  | Extra-curricular activities | Binary: yes or no  
Nursery     | Attended nursery school as a child | Binary: yes or no  
Higher      | Students wants to attend higher education | Binary: yes or no  
Internet    | Internet access at home | Binary: yes or no  
Romantic    | Student pursuing romantic relationship | Binary: yes or no  
Famrel      | Quality of family relationships | Categorical: from 1 - very bad to 5 - excellent  
Freetime    | Free time after school | Categorical: from 1 - very low to 5 - very high  
Goout       | Frequency of going out with friends | Categorical: from 1 - very low to 5 - very high  
Dalc        | Workday alcohol consumption | Categorical: from 1 - very low to 5 - very high  
Walc        | Weekend alcohol consumption | Categorical: from 1 - very low to 5 - very high  
Health      | Current health status | Categorical : from 1 - very bad to 5 - very good  
Absences    | Number of school absences | Numeric: from 0 to 93  
G1  | First Period Grade | Numeric: from 1 to 20
G2  | Second Period Grade | Numeric: from 1 to 20
G3  | Final Grade  | Numeric: from 1 to 20

## Convert Factors to Numeric
```{r}
por_ds$observationID <- seq.int(nrow(por_ds))

por_ds$schoolD <- por_ds$school
levels(por_ds$schoolD) <- c(0, 1) # 0 is GP, 1 is MS
por_ds$schoolD <- as.numeric(as.character(por_ds$schoolD))

por_ds$sexD <- por_ds$sex
levels(por_ds$sexD) <- c(0, 1) #0 is female, 1 is male
por_ds$sexD <- as.numeric(as.character(por_ds$sexD))

por_ds$addressD <- por_ds$address
levels(por_ds$addressD) <- c(0, 1) #0 is urban, 1 is rural
por_ds$addressD <- as.numeric(as.character(por_ds$addressD))

por_ds$famsizeD <- por_ds$famsize
levels(por_ds$famsizeD) <- c(0, 1) #0 is less than 3, 1 is greater than 3
por_ds$famsizeD <- as.numeric(as.character(por_ds$famsizeD))

por_ds$PstatusD <- por_ds$Pstatus
levels(por_ds$PstatusD) <- c(0, 1) #0 is together, 1 is apart
por_ds$PstatusD <- as.numeric(as.character(por_ds$PstatusD))

por_ds$schoolsupD <- por_ds$schoolsup
levels(por_ds$schoolsupD) <- c(0, 1)
por_ds$schoolsupD <- as.numeric(as.character(por_ds$schoolsupD))

por_ds$nurseryD <- por_ds$nursery
levels(por_ds$nurseryD) <- c(0, 1) #0 is yes, 1 is no
por_ds$nurseryD <- as.numeric(as.character(por_ds$nurseryD))

por_ds$activitiesD <- por_ds$activities
levels(por_ds$activitiesD) <- c(0, 1) #0 is female, 1 is male
por_ds$activitiesD <- as.numeric(as.character(por_ds$activitiesD))

por_ds$higherD <- por_ds$higher
levels(por_ds$higherD) <- c(0, 1) #0 is female, 1 is male
por_ds$higherD <- as.numeric(as.character(por_ds$higherD))

por_ds$romanticD <- por_ds$romantic
levels(por_ds$romanticD) <- c(0, 1) #0 is female, 1 is male
por_ds$romanticD <- as.numeric(as.character(por_ds$romanticD))

por_ds$famsupD <- por_ds$famsup
levels(por_ds$famsupD) <- c(0, 1) #0 is female, 1 is male
por_ds$famsupD <- as.numeric(as.character(por_ds$famsupD))

por_ds$paidD <- por_ds$paid
levels(por_ds$paidD) <- c(0, 1) #0 is female, 1 is male
por_ds$paidD <- as.numeric(as.character(por_ds$paidD))

por_ds$internetD <- por_ds$internet
levels(por_ds$internetD) <- c(0, 1) #0 is female, 1 is male
por_ds$internetD <- as.numeric(as.character(por_ds$internetD))


mjob <- factor(por_ds$Mjob)
mjobD <- data.frame(model.matrix(~mjob-1))
mjobD$observationID <- seq.int(nrow(mjobD))
fjob <- factor(por_ds$Fjob)
fjobD <- data.frame(model.matrix(~fjob-1))
fjobD$observationID <- seq.int(nrow(fjobD))
reason <- factor(por_ds$reason)
reasonD <- data.frame(model.matrix(~reason-1))
reasonD$observationID <- seq.int(nrow(reasonD))
guardian <- factor(por_ds$guardian)
guardianD <- data.frame(model.matrix(~guardian-1))
guardianD$observationID <- seq.int(nrow(guardianD))
por_ds <- merge(por_ds, mjobD, by = "observationID")
por_ds <- merge(por_ds, fjobD, by = "observationID")
por_ds <- merge(por_ds, reasonD, by = "observationID")
por_ds <- merge(por_ds, guardianD, by = "observationID")

```



## Descriptive Statistics
```{r}
#slice data in different ways

round(prop.table(table(por_ds$sex,por_ds$school),margin = 2),2)

ddply(por_ds, .(school), summarize, mean = mean(G3), sd = sd(G3))

# Most of the students in this data set study at Gabriel Pereira (772 out of 1044)
# Female Percent
f_pct <- paste0(nrow(student_ds[student_ds[,"sex"] == "F",]) / nrow(student_ds) * 100, "%")
# 56.6% female students
# Male Percent
m_pct <- paste0(nrow(student_ds[student_ds[,"sex"] == "M",]) / nrow(student_ds) * 100, "%")
# 43.4% male students
# Average grade of female students
f_grade <- mean(student_ds[student_ds[,"sex"] == "F", "G3"])
# 11.44839
# Average grade of male students
m_grade <- mean(student_ds[student_ds[,"sex"] == "M", "G3"])
# 11.20309


```



## Correlations

You'll need the package GGally for this

```{r}
correlations <- cor(por_ds[,unlist(lapply(por_ds, is.numeric))])
correlations
melted_cormat <- melt(correlations)
melted_cormat
ggplot(melted_cormat, aes(x = X1, y = X2, fill = value)) + geom_tile() + scale_fill_gradient(low = 'white', high = 'red')

highly_correlated <- melted_cormat[melted_cormat$value > .3, ]
highly_correlated <- highly_correlated[highly_correlated$value < 1 , ]
highly_correlated #list of all correlations above .3
```

## All pairwise correlations

```{r}
cor.vec<-matrix(nrow=dim(mat_ds)[2],ncol=dim(mat_ds)[2])
for (i in 1:dim(mat_ds)[2]) {
  for (j in 1:dim(mat_ds)[2]) {
    if (i != j) {
      cor.vec[i,j] <- as.numeric(try(cor(mat_ds[,i],mat_ds[,j]),silent=TRUE)) 
    }
  }
}

which(abs(cor.vec) > 0.4, arr.ind=TRUE)

```

##Paired t-tests

```{r}
t.test(mat_ds$G1,mat_ds$G2,paired=TRUE) #Checking for improvement in score
t.test(por_ds$G1,por_ds$G2,paired=TRUE) 

#Checks that scores increase similarly across tests (Difference in score between G2 and G1)
mat_ds$scoreDiff1<-mat_ds$G2 - mat_ds$G1
por_ds$scoreDiff1<-por_ds$G2 - por_ds$G1
t.test(mat_ds$scoreDiff1,mat_ds$scoreDiff1)


#do a t.test between male and female grades.
# t.test between the two schoools. 
# Difference between female and male proportions with respect to certain characteristics
prop.test(table(student_ds$sex, student_ds$activities), correct = FALSE)
#prop test make sure the y/n is on the columns
prop.test(table(student_ds$nursery, student_ds$sex), correct = FALSE)
prop.test(table(student_ds$higher, student_ds$sex), correct = FALSE)
prop.test(table(student_ds$internet, student_ds$sex), correct = FALSE)
prop.test(table(student_ds$romantic, student_ds$sex), correct = FALSE)


```

## Chisquare Test

The aim of this section is to test independency between variables.
```{r}
## Independency of gender on willingness to pursue higher education
# Gender influences the desire for a student on whether or not to pursue a higher degree education. This could due to socially perceived roles of gender in the society. 

# p-value = 0.005565
gender_higher <- table(mat_ds$sex, mat_ds$higher)
chisq.test (gender_higher)

## Independence of gender on failure rates.
# Gender was shown not to have an impact on the exam failure rates. 

# P-value = 0.3169
gender_failure <- table(mat_ds$sex, mat_ds$failures)
chisq.test (gender_failure)

## Independence of gender on studytime.
# The result below showed that there is a dependency between study times and gender. This gender gap could be that boys tend to spend less time studying compared to girls and girls feel anxiety from school work more easily and have better disipline at home. Ref: https://www.thestar.com/yourtoronto/education/2015/03/05/boys-do-less-homework-than-girls-global-study-finds.html

#P-value = 5.854*10^-11
gender_st <- table(mat_ds$sex, mat_ds$studytime)
chisq.test (gender_st)


## Independence of going out frequency on alcohol consumption.
# A student's alcohol consumption is linked with his/her going out frequency. A person normally tends to drink more as his/her frequency of going out increases. 

#P-value = 3.571*10^-5
goout_Dalc <- table(mat_ds$goout, mat_ds$Dalc)
chisq.test(goout_Dalc)

# P-value =  2.2*10^-16
goout_walc <- table(mat_ds$goout, mat_ds$Walc)
chisq.test(goout_walc)

## Independence of free time on going out frequency.
# Going out frequency is dependent on the amount of free time a student has. Generally speaking, the more free time a person has, the more often this person hangs out with friends or socialises with people.
# P-value = 1.156*10^-10 
freetime_goout <- table( mat_ds$freetime, mat_ds$goout)
chisq.test(freetime_goout)

## Independence of parents' jobs on the paid activities a student take.
# Paid activities are dependent on mother's jobs but independent of father's jobs. The reason being could be that mothers are naturally more devoted to the children's development.

#P-value = 0.01211
Mjob_paid <- table(mat_ds$Mjob, mat_ds$paid)
chisq.test(Mjob_paid)

#P-value = 0.4754
Fjob_paid <- table(mat_ds$Fjob, mat_ds$paid)
chisq.test(Fjob_paid)

## Independence of paid activities on failure rates.
# Whether or not a student takes extra paid classes affects his/her exam failure rate. The more extra paid classes a student receives, the better scores he/she achieves and the less chance of failing an exam.

# P-value = 0.0003407
paid_failure <- table(mat_ds$failures, mat_ds$paid)
chisq.test(paid_failure)

## Independence of parents' education on a student's desire to pursue higher education. 
# It was found that higher education is associated with parents' education backgrounds. This could be explained by the fact that parents' education levels dictate their expectations of their offsprings. Students generally take their parents as their role models and pursue the same or if not higher education as compared to their parents.
Medu_higher <- table(mat_ds$Medu, mat_ds$higher)
chisq.test(Medu_higher)

# P-value = 0.006636
Fedu_higher <- table(mat_ds$Fedu, mat_ds$higher)
chisq.test(Fedu_higher)

## Independence of acohol consumption on health.
# The chi-square results showed that a student's health is independent of his/her acohol consumption. This surprising result could be due to the fact that the samples were taken from young students age 16 to 18. The long term effects from acohol on health was not yet shown.

# P-value = 0.1564
acohol_health <- table(mat_ds$Dalc, mat_ds$health)
chisq.test(acohol_health)

# p-value = 0.2894
walc_health <- table(mat_ds$Walc, mat_ds$health)
chisq.test(walc_health)

## Independence of guardian on health.
# The result below showed that a student's guardian influences his/her health. Possible explainations could be that mothers for example can care for their children's health better than others due to mothers' nurturing nature.

# P-value = 0.004591
guardian_health <- table(mat_ds$guardian, mat_ds$health)
chisq.test(guardian_health)

## Independence of traveltime on failure rates.
# Travel time to school was proved to have an effect on a student's failure rate. This could be due to the fact that longer travelling time to school may cause lateness or poorer concentration in class which would in turn affect a student's academic performance. 

# P-value = 0.01211
traveltime_failure <- table(mat_ds$failures, mat_ds$traveltime)
chisq.test (traveltime_failure)

## Independence of romantic relationships on study time.
# The results suggested that being in a romantic relationship can affect the amount of time a student spend on studying. This might be due to the fact that Students in a relationship are more likely to be distracted from school work or lose intersts in class. 
# P-value = 0.01368
romantic_studytime <- table(mat_ds$romantic, mat_ds$studytime)
chisq.test(romantic_studytime)

## Independence of romantic relationships on failure rates.
# Wether or not a student's involvement in a romantic relationship was shown to an impact on his/her academic achievement/failure rates. This could be because being in a romatic relationship could lead to spending less time in studying or lose focus in school work and hence underachievement in exams.

# P-value = 0.02365
romantic_failure <- table(mat_ds$romantic, mat_ds$failures)
chisq.test(romantic_failure)

```




Difference in score for mat_ds(math) is insignificant, but significant for por_ds(portugese)

## Some quick ANOVA

Just to explore a bit further

```{r}
Edu.aov<-aov(mat_ds$G3 ~ mat_ds$Fedu + mat_ds$Medu)
Alc.aov<-aov(mat_ds$G3 ~ mat_ds$Walc + mat_ds$Dalc)
Job.aov<-aov(mat_ds$G3 ~ mat_ds$Mjob + mat_ds$Fjob)
summary(aov(mat_ds$G3 ~ factor(mat_ds$studytime)))
ggplot(data=mat_ds,aes(factor(Mjob),G3))+geom_boxplot()
```


## PCA

```{r}
mat_ds.sub<-as.data.frame(mat_ds[,c(7,8,26,27,28,30,31,32,33)])

mat_ds.sub<-as.data.frame(mat_ds[,nonFactors])
mat_ds.pca<-prcomp(mat_ds.sub,scale=TRUE,center=TRUE)

pairs(as.matrix(mat_ds.sub)%*%as.matrix(mat_ds.pca$rotation)[,1:7],col=mat_ds$traveltime)
mat_ds.pca$rotation
```

## Linear Models
```{r}
# questions to ask. does mom or dad's education status and/or job affect scores more
# looks like having a romantic interest distracts students from studying
# also looks like urban students do better than rural ones
# one of the schools does way better than the other? can we find out how much of that school variation is due to the school vs other characteristics

# MA model
# Negative relationships
summary(lm(formula = student_ds$G3 ~ student_ds$health, data = student_ds))
# p-value: 0.00964 , slope: -0.21723
summary(lm(formula = student_ds$G3 ~ student_ds$Walc, data = student_ds))
# p-value: 0.000178 , slope: -0.34807
summary(lm(formula = student_ds$G3 ~ student_ds$Dalc, data = student_ds))
# p-value: 2.65e-05 , slope: -0.5496
summary(lm(formula = student_ds$G3 ~ student_ds$goout, data = student_ds))
# p-value: 0.00154 , slope: -0.3282
summary(lm(formula = student_ds$G3 ~ student_ds$freetime, data = student_ds))
# p-value: 0.0361 , slope: -0.2431
summary(lm(formula = student_ds$G3 ~ student_ds$romantic, data = student_ds))
# p-value: 0.00146 , slope: -0.7939
summary(lm(formula = student_ds$G3 ~ student_ds$traveltime, data = student_ds))
# p-value: 0.000898 , slope: -0.5421

# Positive relationships
summary(lm(formula = student_ds$G3 ~ student_ds$internet, data = student_ds))
# p-value: 0.0005299 , slope: 1.0192
summary(lm(formula = student_ds$G3 ~ student_ds$higher, data = student_ds))
# p-value: 9.55e-15 , slope: 3.2726
summary(lm(formula = student_ds$G3 ~ student_ds$studytime, data = student_ds))
# p-value: 1.52e-07 , slope: 0.7487
summary(lm(formula = student_ds$G3 ~ student_ds$Fjob, data = student_ds))
# p-value: 0.007 , slope: 1.8454 (Fjobteacher)
summary(lm(formula = student_ds$G3 ~ student_ds$Mjob, data = student_ds))
# p-value: 1.16e-05 , slope: 2.2139 (Mjobhealth)
# p-value: 0.00126 , slope: 1.1920 (Mjobservices)
# p-value: 6.21e-05 , slope: 1.7386 (Mjobteacher)
summary(lm(formula = student_ds$G3 ~ student_ds$Fedu, data = student_ds))
# p-value: 2.1e-07 , slope: 0.5615
summary(lm(formula = student_ds$G3 ~ student_ds$Medu, data = student_ds))
# p-value: 5.05e-11 , slope: 0.6922

# should we convert categorical variables to factors?
mopor_ds <- lm(formula = student_ds$G3 ~ student_ds$higher + student_ds$studytime + 
             student_ds$Mjob + student_ds$Fedu + student_ds$Medu + student_ds$Walc + 
             student_ds$Dalc + student_ds$traveltime, data = student_ds)
summary(mopor_ds)
#final thing is how does the model for G3 differ between math and portuguese
```
